- name: Deploy to server
  env:
    SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
  run: |
    ssh -i ~/.ssh/deploy_key -p "${{ secrets.SERVER_PORT }}" \
      -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=~/.ssh/known_hosts \
      "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << 'ENDSSH'
      set -euo pipefail
      echo "[deploy] start"

      cd /home/ubuntu/myblog   # ← 실제 리포 경로(지금 이게 맞음)

      # rbenv 초기화 (비대화식 세션에서 PATH 잡기)
      export RBENV_ROOT="$HOME/.rbenv"
      export PATH="$RBENV_ROOT/bin:$PATH"
      eval "$(rbenv init - bash)"
      hash -r

      # Ruby/Bundler 대비(없으면 설치)
      command -v ruby >/dev/null || rbenv install -s 3.3.5
      rbenv global 3.3.5
      gem install bundler --no-document || true

      echo "[deploy] git pull"
      git pull --ff-only origin main

      echo "[deploy] bundle install"
      bundle install

      echo "[deploy] jekyll build"
      bundle exec jekyll build -s . -d _site

      echo "[deploy] rsync to web root"
      rsync -az --delete _site/ /var/www/myblog/

      echo "[deploy] done"
ENDSSH
